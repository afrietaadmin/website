<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Afrieta Community Internet</title>
  <meta name="title" content="Afrieta" />
  <meta name="description" content="AFRIETA Community Internet is a leading internet service provider that offers high-speed internet connectivity to residential and business customers." />

  <link rel="shortcut icon" href="./icon.png" type="image/svg+xml" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="stylesheet" href="./assets/css/style.css" />

  <link rel="preload" as="image" href="./assets/images/hero-bg.jpg" />
  <link rel="preload" as="image" href="./assets/images/hero-slide-1.jpg" />
  <link rel="preload" as="image" href="./assets/images/hero-slide-2.jpg" />
  <link rel="preload" as="image" href="./assets/images/hero-slide-3.jpg" />

  <style>
    main {
      padding: 50px 0;
    }

    section {
      padding: 20px 0 !important;
    }

    .header {
      background-color: #262626;
    }

    body {
      color: #424141;
    }

    .subtext {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px
    }

    .chip {
      display: inline-block;
      font-size: 14px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(236, 5, 236, 0.5);
      color: #333;
    }

    .speed {
      margin-top: 8px;
      font-size: 20px;
      font-weight: 800
    }

    .tier {
      color: var(--muted);
      font-size: 15px;
    }

    .price {
      margin-top: 13px;
      font-size: 28px;
      font-weight: 900
    }

    .per {
      color: var(--muted);
      font-size: 14px;
      margin-left: 6px;
      font-weight: 500
    }

    .hidden {
      display: none !important
    }

    /* ===== Afrieta modal (namespaced) ===== */
    :root {
      --af-bg: #0b0f14;
      --af-panel: #0f1621;
      --af-border: rgba(255, 255, 255, .08);
      --af-text: #f5f7fb;
      --af-muted: #9fb0c6;
      --af-accent: #ee06ee;
      --af-shadow: 0 18px 60px rgba(0, 0, 0, .45);
    }

    .af-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(8, 12, 18, .65);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10000;
    }

    .af-modal {
      width: min(70%, 100%);
      height: 650px;
      overflow: auto !important;
      background: radial-gradient(1200px 600px at 70% -10%, #262626 0%, var(--af-panel) 55%);
      border: 1px solid var(--af-border);
      border-radius: 18px;
      color: var(--af-text);
      box-shadow: var(--af-shadow);
      overflow: hidden;
      transform: translateY(10px) scale(.98);
      opacity: 0;
      transition: transform .18s ease, opacity .18s ease;
    }

    .af-backdrop[style*="display: flex"] .af-modal {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .af-modal__header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--af-border);
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, 0));
    }

    .af-modal__title {
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
    }

    .af-modal__body {
      padding: 18px 20px 20px;
    }

    .af-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 560px) {
      .af-grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .af-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .af-field>label {
      font-size: 14px;
      color: var(--af-muted);
    }
     #signupForm {
          padding: 40px;
          box-shadow: var(--shadow-2);
          border-radius: var(--radius-6);
     }
          #signupForm .af-field>label {
            color: unset;
          }
    #signupForm .af-field>input,
     #signupForm .af-field>select {
    background: transparent;
    border: 1px solid #424141;
    color: unset;
    border-radius: 10px;
    padding: 10px 12px;
    outline: none;
    height: 49.19px;
    }

     #signupForm .af-field>input::placeholder {
     color: #1b1b1b;
     }

    .af-field>input,
    .af-field>select {
      background: #0b121b;
      border: 1px solid var(--af-border);
      color: unset;
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }

    .af-field>input::placeholder {
      color: #6f8096;
    }

    .af-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .af-actions .btn:hover {
      border: none;
    }

    .af-actions .btn-primary:hover {
      background: #ee06ee;
      color: #fff;
    }

    .af-field>input:focus {
      box-shadow: 0 0 0 2px rgba(236, 5, 236, .35);
      border-color: rgba(236, 5, 236, .55);
    }
     #signupForm .af-field>input:focus {
      box-shadow: 0 0 0 2px #424141;
      border-color: #424141;
    }

    #signupForm .af-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    }
    /* ====== Toasts ====== */
    #af-toast {
      position: fixed;
      top: 18px;
      right: 18px;
      display: grid;
      gap: 10px;
      z-index: 12000;
    }

    .af-toast {
      min-width: 260px;
      max-width: 360px;
      padding: 12px 14px;
      border-radius: 12px;
      color: #0b0f14;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      font-weight: 700;
      letter-spacing: .2px;
    }

    .af-toast.info {
      background: #ffe680;
    }

    .af-toast.success {
      background: #a9f0d6;
    }

    .af-toast.error {
      background: #ffc2c2;
    }

    /* Result block tweaks */
    .result-block p {
      margin: 4px 0;
    }

    .result-block h4 {
      margin: 6px 0;
      font-weight: 700;
      color: #f5f7fb;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
    }

    .badge.ok {
      background: #a9f0d6;
      color: #053b2e;
    }

    .badge.warn {
      background: #ffe680;
      color: #513e00;
    }

    .badge.err {
      background: #ffc2c2;
      color: #5c0000;
    }

    html {
      scroll-behavior: smooth;
    }

    /* ===== Coverage Results Grid ===== */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 560px) {
      .product-grid {
        grid-template-columns: 1fr;
      }
    }

    .product-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 10px 12px;
      transition: all .2s ease;
    }

    .product-card:hover {
      transform: translateY(-3px);
      background: rgba(255, 255, 255, 0.08);
    }

    .product-card h5 {
      margin: 0 0 4px;
      font-size: 14px;
      font-weight: 700;
      color: #f5f7fb;
    }

    .product-card small {
      color: #9fb0c6;
      font-size: 12px;
    }

    .product-card p {
      margin: 2px 0 0;
      font-size: 13px;
      color: #d8d8d8;
    }
  </style>
</head>

<body>
  <header class="header" data-header>
    <div class="container">
      <a href="#" class="logo">
        <img src="./assets/images/logo-white.png" width="150" height="80" alt="Adex home" class="logo-light" />
        <img src="./assets/images/logo.png" width="150" height="80" alt="Adex home" class="logo-dark" />
      </a>

      <nav class="navbar" data-navbar>
        <div class="navbar-top">
          <a href="#" class="logo"><img src="./assets/images/logo-white.png" width="150" height="80" alt="Adex home" /></a>
          <button class="nav-close-btn" aria-label="close menu" data-nav-toggler>
            <ion-icon name="close-outline" aria-hidden="true"></ion-icon>
          </button>
        </div>

        <ul class="navbar-list">
          <li><a href="#" class="navbar-link">Home</a></li>
          <li><a href="#locations" class="navbar-link">Locations</a></li>
          <li><a href="#services" class="navbar-link">Services</a></li>
        </ul>

        <div class="wrapper">
          <a href="mailto:info@email.com" class="contact-link">admin@afrieta.com</a>
          <a href="tel:001234567890" class="contact-link">+(27) 16 880 0300</a>
        </div>

        <ul class="social-list">
          <a href="http://wa.link/a7sfoi" target="_blank" class="mob-btn">
            <div class="d-flex">
              <ion-icon name="logo-whatsapp"></ion-icon>Chat with Us
            </div>
          </a>
        </ul>
      </nav>

      <a href="http://wa.link/a7sfoi" target="_blank" class="btn btn-primary">
        <div class="d-flex">
          <ion-icon name="logo-whatsapp"></ion-icon>Chat with Us
        </div>
      </a>

      <button class="nav-open-btn" aria-label="open menu" data-nav-toggler>
        <ion-icon name="menu-outline" aria-hidden="true"></ion-icon>
      </button>
      <div class="overlay" data-nav-toggler data-overlay></div>
    </div>
  </header>

  <main class="container">
    <h1 class="mb-3">Afrieta Fibre Packages</h1>
    <p class="subtext">Say goodbye to buffering. Check coverage in seconds to discover the Afrieta Fibre packages available at this address.</p>
    <div><button id="openCoverage" class="btn btn-dark">Check coverage</button></div>

    <!-- WebConnect -->
    <section class="section">
      <h2>Openserve WebConnect </h2>
      <div class="grid" id="grid-webconnect"></div>
    </section>

    <!-- WebStream -->
    <section class="section">
      <h2>Openserve WebStream</h2>
      <div class="grid" id="grid-webstream"></div>
    </section>

    <!-- FibreConnect / Afrieta APL -->
    <section class="section">
      <h2>Openserve FibreConnect </h2>
      <div class="grid" id="grid-fibreconnect"></div>
    </section>

    <!-- Toasts + embedded area (now custom signup form, hidden by default) -->
    <div id="af-toast"></div>
    <div id="embed" class="embed-wrap hidden">
      <!-- Custom Signup Form will be injected here -->
      <div id="signupFormContainer"></div>
    </div>
  </main>

  <!-- Coverage modal -->
  <div class="af-backdrop" id="backdrop" aria-hidden="true">
    <div class="af-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header class="af-modal__header">
        <div id="modalTitle" class="af-modal__title">Check coverage</div>
      </header>
      <div class="af-modal__body">
        <form id="coverageForm">
          <div class="af-grid-2">
            <div class="af-field">
              <label for="houseNumber">House number</label>
              <input id="houseNumber" name="houseNumber" placeholder="e.g., 12" required />
            </div>
            <div class="af-field">
              <label for="streetName">Street name</label>
              <input id="streetName" name="streetName" placeholder="e.g., Example St" required />
            </div>
          </div>

          <div class="af-grid-2">
            <div class="af-field">
              <label for="buildingName">Building name / Building number (optional)</label>
              <input id="buildingName" name="buildingName" placeholder="e.g., Kings Tower" />
            </div>

            <div class="af-field">
              <label for="floorNumber">Floor number (optional)</label>
              <input id="floorNumber" name="floorNumber" placeholder="e.g., 3rd Floor" />
            </div>
          </div>

          <div class="af-grid-2">
            <div class="af-field">
              <label for="suburbName">Suburb name</label>
              <input id="suburbName" name="suburbName" placeholder="e.g., Rosebank" required />
            </div>
            <div class="af-field">
              <label for="province">Province</label>
              <input id="province" name="province" placeholder="e.g., Gauteng" required />
            </div>
          </div>

          <div class="af-field">
            <label for="postalCode">Postal code</label>
            <input id="postalCode" name="postalCode" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="e.g., 2196" required />
          </div>

          <div class="af-actions">
            <button type="button" class="btn btn-dark" id="cancelBtn">Cancel</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">Check availability</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2024 Afrieta Pty Ltd. All rights reserved.</p>
    <div class="text-two"><a href="tel:+27168800300" class="underline">+(27) 16 880 0300</a></div>
  </footer>

  <script>
    /* ---------- Afrieta prices ---------- */
    const WEB_CONNECT = [{
        speed: "10 / 10 Mbps",
        price: 379,
        tag: "Popular",
        cat: "WebConnect"
      },
      {
        speed: "20 / 10 Mbps",
        price: 449,
        cat: "WebConnect"
      },
      {
        speed: "40 / 20 Mbps",
        price: 509,
        cat: "WebConnect"
      }
    ];
    const WEB_STREAM = [{
        speed: "25 / 25 Mbps",
        price: 639,
        cat: "WebStream"
      },
      {
        speed: "50 / 25 Mbps",
        price: 799,
        tag: "Popular",
        cat: "WebStream"
      },
      {
        speed: "100 / 50 Mbps",
        price: 959,
        cat: "WebStream"
      },
      {
        speed: "200 / 100 Mbps",
        price: 1099,
        cat: "WebStream"
      },
      {
        speed: "300 / 150 Mbps",
        price: 1209,
        cat: "WebStream"
      },
      {
        speed: "500 / 250 Mbps",
        price: 1309,
        cat: "WebStream"
      }
    ];
    const FIBRE_CONNECT = [{
        speed: "50 / 50 Mbps",
        price: 750,
        cat: "FibreConnect"
      },
      {
        speed: "100 / 100 Mbps",
        price: 819,
        cat: "FibreConnect"
      },
      {
        speed: "300 / 150 Mbps",
        price: 1045,
        cat: "FibreConnect"
      },
      {
        speed: "500 / 250 Mbps",
        price: 1299,
        tag: "Best value",
        cat: "FibreConnect"
      },
      {
        speed: "500 / 250 Mbps (Premium)",
        price: 1550,
        cat: "FibreConnect"
      }
    ];
    const ALL_PACKAGES = [...WEB_CONNECT, ...WEB_STREAM, ...FIBRE_CONNECT];

    const toRand = v => "R" + v.toLocaleString("en-ZA");

    function renderSection(list, mountId, label) {
      const host = document.getElementById(mountId);
      host.innerHTML = "";
      list.forEach(p => {
        const el = document.createElement("article");
        el.className = "service-card";
        el.innerHTML = `
          ${p.tag ? `<span class="chip">${p.tag}</span>` : ""}
          <div class="speed">${p.speed}</div>
          <div class="tier">${label}</div>
          <div class="price">${toRand(p.price)} <span class="per">per month</span></div>
        `;
        host.appendChild(el);
      });
    }
    renderSection(WEB_CONNECT, "grid-webconnect", "WebConnect");
    renderSection(WEB_STREAM, "grid-webstream", "WebStream");
    renderSection(FIBRE_CONNECT, "grid-fibreconnect", "FibreConnect");

    /* ---------- Elements ---------- */
    const openBtn = document.getElementById("openCoverage");
    const backdrop = document.getElementById("backdrop");
    const form = document.getElementById("coverageForm");
    const cancelBtn = document.getElementById("cancelBtn");
    const embedWrap = document.getElementById("embed");
    const signupFormContainer = document.getElementById("signupFormContainer");
    const submitBtn = document.getElementById("submitBtn");
    const modalBody = document.querySelector(".af-modal__body");
    const modalTitle = document.getElementById("modalTitle");

    /* ---------- Toasts ---------- */
    function showToast(type, message, ms = 3200) {
      const host = document.getElementById('af-toast');
      const el = document.createElement('div');
      el.className = `af-toast ${type}`;
      el.textContent = message;
      host.appendChild(el);
      setTimeout(() => {
        el.style.transition = 'opacity .25s ease, transform .25s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateY(-6px)';
        setTimeout(() => host.removeChild(el), 260);
      }, ms);
    }

    /* ---------- Modal open/close ---------- */
    function openModal() {
      // Ensure form is visible when opening (in case last time we showed results)
      if (!modalBody.contains(form)) {
        modalBody.innerHTML = "";
        modalBody.appendChild(form);
      }
      modalTitle.textContent = "Check coverage";
      backdrop.style.display = "flex";
      backdrop.removeAttribute("aria-hidden");
      setTimeout(() => document.getElementById("houseNumber").focus(), 30);
    }

    function closeModal() {
      form.reset();
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
    }
    openBtn.addEventListener("click", openModal);
    cancelBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", e => {
      if (e.target === backdrop) closeModal();
    });
    document.addEventListener("keydown", e => {
      if (e.key === "Escape") closeModal();
    });

    /* ---------- Backend coverage call ---------- */
    async function checkCoverage(address) {
      const res = await fetch('https://api.afrieta.com/openserve/product-qualification', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(address)
      });
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(t || 'Coverage check failed');
      }
      return res.json();
    }

    const allPackages = [
    { name: "Afrieta Fibre OWC 10Mbps/10Mbps", price: 379 },
    { name: "Afrieta Fibre OWC 20Mbps/10Mbps", price: 449 },
    { name: "Afrieta Fibre OWC 40Mbps/20Mbps", price: 509 },
    { name: "Afrieta Fibre OWS 25Mbps/25Mbps", price: 639 },
    { name: "Afrieta Fibre OWS 50Mbps/25Mbps", price: 799 },
    { name: "Afrieta Fibre OWS 100Mbps/50Mbps", price: 959 },
    { name: "Afrieta Fibre OWS 200Mbps/100Mbps", price: 1099 },
    { name: "Afrieta Fibre OWS 300Mbps/150Mbps", price: 1209 },
    { name: "Afrieta Fibre OWS 500Mbps/250Mbps", price: 1399 },
    { name: "Afrieta Premium Fibre OFC 50Mbs/25Mbs", price: 750 },
    { name: "Afrieta Premium Fibre OFC 50Mbs/50Mbs", price: 819 },
    { name: "Afrieta Premium Fibre OFC 100Mbs/50Mbs", price: 919 },
    { name: "Afrieta Premium Fibre OFC 100Mbs/100Mbs", price: 1045 },
    { name: "Afrieta Premium Fibre OFC 300Mbs/150Mbs", price: 1299 },
    { name: "Afrieta Premium Fibre OFC 500Mbs/250Mbs", price: 1550 },
];
    /* ---------- Render custom signup form (replaces Cognito) ---------- */
    function renderSignupForm(result, address) {
      const {
        AddressInfo = {}, ftthProductInfo = []
      } = result || {};
      const building = address.buildingName || AddressInfo.LR_BUILDING_NAME || "";
      const floor = address.floorNumber || AddressInfo.LR_FLOOR || "";

// Generate dropdown options grouped by Product
const packageOptions = ftthProductInfo.map(product => {
  // Get all packages belonging to this product code (OFC, OWS, OWC)
  const relatedPackages = allPackages.filter(pkg =>
    pkg.name.includes(product.ProductCode)
  );

  if (relatedPackages.length === 0) return '';

  const options = relatedPackages
    .map(pkg => {
      const text = `${pkg.name} = R${pkg.price.toLocaleString()}`;
      return `<option value="${product.ProductCode}">${text}</option>`;
    })
    .join("");
    let label;

    if (product.ProductName == 'Openserve Fibre Connect') {
      label = 'Afrieta Premium Fibre OFC'
    } else if(product.ProductName == 'Openserve Web Connect') {
      label = 'Afrieta Fibre OWC'
    }
    else if(product.ProductName == 'Openserve Webstream'){
      label = 'Afrieta Fibre OWS'
    }

  return `
    <optgroup label="${label}">
      ${options}
    </optgroup>
  `;
}).join("");

      signupFormContainer.innerHTML = `
        <form id="signupForm">
          <h2>Afrieta Fibre Sign-up</h2>
          <div class="af-grid-3">
            <div class="af-field"><label>Title</label><input id="title" required /></div>
            <div class="af-field"><label>First name</label><input id="firstName" required /></div>
            <div class="af-field"><label>Last name</label><input id="lastName" required /></div>
          </div>
          <div class="af-grid-3">
            <div class="af-field"><label>Email Address</label><input id="email" type="email" required /></div>
            <div class="af-field"><label>Phone Number</label><input id="phone" type="tel" required /></div>
            <div class="af-field"><label>WhatsApp Number</label><input id="whatsapp" type="tel" required /></div>
          </div>
       <div class="af-field"><label>Identity Number/Passport Number</label><input id="idNumber" required /></div>

          <h3>Address</h3>
          <div class="af-grid-2">
            <div class="af-field"><label>House number</label><input id="addr_house" value="${address.houseNumber}" readonly /></div>
            <div class="af-field"><label>Street name</label><input id="addr_street" value="${address.streetName}" readonly /></div>
          </div>
          <div class="af-grid-2">
            ${building ? `<div class="af-field"><label>Building name/number</label><input id="addr_building" value="${building}" readonly /></div>` : ""}
            ${floor ? `<div class="af-field"><label>Floor number</label><input id="addr_floor" value="${floor}" readonly /></div>` : ""}
          </div>
          <div class="af-grid-3">
            <div class="af-field"><label>Suburb</label><input id="addr_suburb" value="${address.suburbName}" readonly /></div>
            <div class="af-field"><label>Province</label><input id="addr_province" value="${address.province}" readonly /></div>
            <div class="af-field"><label>Postal code</label><input id="addr_postal" value="${address.postalCode}" readonly /></div>
          </div>

          <h3>Connection Details</h3>
          <div class="af-grid-3">
            <div class="af-field">
              <label>Select your package</label>
              <select id="packageCode" required>
                <option value="">-- Select --</option>
                ${packageOptions}
              </select>
            </div>
            <div class="af-field"><label>WiFi Name (SSID)</label><input id="wifiName" required /></div>
            <div class="af-field"><label>WiFi Password</label><input id="wifiPassword" type="password" required /></div>
          </div>

          <!-- <h3>Authorisation</h3>
          <div class="af-field"><label>Signature</label><input id="signature" placeholder="Type full name" required /></div>
          <div class="af-grid-2">
            <div class="af-field"><label>Date</label><input id="dateSigned" type="date" placeholder="Signed on" required /></div>
            <div class="af-field"><label>Place</label><input id="place" value="${address.suburbName}, ${address.province}" readonly /></div>
          </div> -->

          <label style="display:flex; gap:8px; align-items:flex-start; margin-top:10px;">
            <input type="checkbox" id="acceptTerms" required />
            <span>By submitting this form, the customer agrees to the full Afrieta T&Cs, and the customer agrees to be bound thereto. The customer is recommended to refer to full T&Cs on the Afrieta website.</span>
          </label>

          <div class="af-actions" style="margin-top:16px;">
            <button type="submit" class="btn btn-dark" id="signupSubmitBtn">Submit Application</button>
          </div>
        </form>
      `;

      // Submit handler (POST JSON to backend)
      const signupForm = document.getElementById("signupForm");
      const signupSubmitBtn = document.getElementById("signupSubmitBtn");
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!signupForm.reportValidity()) return;

        signupSubmitBtn.disabled = true;
        const prevText = signupSubmitBtn.textContent;
        signupSubmitBtn.textContent = "Submitting…";

        const payload = {
          title: document.getElementById("title").value.trim(),
          firstName: document.getElementById("firstName").value.trim(),
          lastName: document.getElementById("lastName").value.trim(),
          email: document.getElementById("email").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          whatsapp: document.getElementById("whatsapp").value.trim(),
          idNumber: document.getElementById("idNumber").value.trim(),
          wifiName: document.getElementById("wifiName").value.trim(),
          wifiPassword: document.getElementById("wifiPassword").value.trim(),
          signature: document.getElementById("signature").value.trim(),
          dateSigned: document.getElementById("dateSigned").value,
          place: document.getElementById("place").value,
          packageCode: document.getElementById("packageCode").value,
          address: {
            houseNumber: address.houseNumber,
            streetName: address.streetName,
            buildingName: building || undefined,
            floorNumber: floor || undefined,
            suburbName: address.suburbName,
            province: address.province,
            postalCode: address.postalCode
          },
          // Optional: include returned products for context/audit
          ftthProductInfo: (result && result.ftthProductInfo) ? result.ftthProductInfo : []
        };

        try {
          const res = await fetch("https://api.afrieta.com/api/register-fibre", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const t = await res.text().catch(() => "");
            throw new Error(t || "Registration failed");
          }
          showToast("success", "Application submitted successfully!");
          signupForm.reset();
        } catch (err) {
          console.error(err);
          showToast("error", "Unable to submit application. Please try again.");
        } finally {
          signupSubmitBtn.disabled = false;
          signupSubmitBtn.textContent = prevText;
        }
      });
    }

    /* ---------- Render result INSIDE the modal ---------- */
    function renderResult(result, address) {
      const {
        FTTH_Status,
        AddressInfo = {},
        ftthProductInfo = []
      } = result || {};
      
// Define the product order
const productOrder = ["OWC", "OWS", "OFC"];
      const status = (FTTH_Status || "").toLowerCase();
      const isAvailable = status === "working";

      const badgeClass = isAvailable ? "ok" : (status ? "warn" : "err");
      const badgeText = isAvailable ? 'Available' : 'Not Available';

      modalTitle.textContent = "Coverage results";
      modalBody.innerHTML = `
        <div class="result-block">
          ${isAvailable ? `
          <p><strong>Status:</strong> <span class="badge ${badgeClass}">${badgeText}</span></p>
          <p><strong>AMID:</strong> ${AddressInfo.AMID || "—"}</p>
          <div class="addr" style="margin-top:8px;">
            <p><strong>Address:</strong> ${AddressInfo.LR_Address || `${address.houseNumber} ${address.streetName}, ${address.suburbName}`}</p>
            <p>${[AddressInfo.LR_SUBURB, AddressInfo.LR_TOWN, AddressInfo.LR_PROVINCE].filter(Boolean).join(", ")}</p>
          </div>
          <hr style="margin:12px 0; border-color:rgba(255,255,255,0.1)">
          <div>
    <h4>Available Products:</h4>
    <ul class="product-grid" style="list-style:none; padding:0; margin:0;">
  ${ftthProductInfo
    // Sort product categories first (OWC → OWS → OFC)
    .sort((a, b) => productOrder.indexOf(a.ProductCode) - productOrder.indexOf(b.ProductCode))
    .map(p => {
      // Match packages to product code
      const relatedPackages = allPackages
        .filter(pkg => pkg.name.includes(p.ProductCode))
        // Sort packages by price ascending
        .sort((a, b) => a.price - b.price);

      // Convert product naming to Afrieta format
      const afrietaName = p.ProductCode === "OFC"
        ? "Afrieta Fibre Premium"
        : "Afrieta Fibre";

      // Render packages as name–value pairs
      return `
        <li class="product-card" style="margin-bottom:16px;">
          <h3 style="font-weight:800; margin-bottom:12px;">
            ${afrietaName} (${p.ProductCode})
          </h3>
          ${relatedPackages.map(pkg => {
            const planName = pkg.name.replace(/Afrieta Fibre (Premium )?${p.ProductCode}\s*/,'').trim();
            return `
              <div style="font-size:15px; opacity:.9; display:flex; flex-direction:column; margin-bottom:6px;">
                <div><strong>Name:</strong> ${planName}</div>
                <div><strong>Price:</strong> R${pkg.price.toLocaleString()}</div>
              </div>
              <hr style="margin:12px 0; border-color:rgba(255,255,255,0.1)">
            `;
          }).join("")}
        </li>
      `;
    }).join("")}
</ul>
  </div>
          ` : `
          <h5 style="margin-bottom: 30px; font-size: 18px;">We are sorry, OpenServe Fibre is not available in this area.</h5>
          `}
          <div class="af-actions" style="margin-top:16px;">
            <button type="button" class="btn btn-dark" id="backBtn">Back</button>
            ${isAvailable ? `<button type="button" class="btn btn-primary" id="continueBtn">Continue</button>` : `<button type="button" class="btn btn-primary" id="tryAgainBtn">Try another address</button>`}
          </div>
        </div>
      `;

      // Back → restore original form
      document.getElementById("backBtn").addEventListener("click", () => {
        modalTitle.textContent = "Check coverage";
        modalBody.innerHTML = "";
        modalBody.appendChild(form);
        setTimeout(() => document.getElementById("houseNumber").focus(), 20);
      });

      // Continue (only shown when available)
      const continueBtn = document.getElementById("continueBtn");
      if (continueBtn) {
        continueBtn.addEventListener("click", () => {
          // Inject and show custom signup form (replacing Cognito)
          renderSignupForm(result, address);
          embedWrap.classList.remove("hidden");
          closeModal();
          embedWrap.scrollIntoView({
            behavior: "smooth",
            block: "start"
          });
        });
      }

      // If not available, try again
      const tryAgainBtn = document.getElementById("tryAgainBtn");
      if (tryAgainBtn) {
        tryAgainBtn.addEventListener("click", () => {
          modalTitle.textContent = "Check coverage";
          modalBody.innerHTML = "";
          modalBody.appendChild(form);
          setTimeout(() => document.getElementById("houseNumber").focus(), 20);
        });
      }
    }

    /* ---------- Form submit → replace modal content with results ---------- */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!form.reportValidity()) return;

      const address = {
        houseNumber: form.houseNumber.value.trim(),
        streetName: form.streetName.value.trim(),
        buildingName: form.buildingName.value.trim(),
        floorNumber: form.floorNumber.value.trim(),
        suburbName: form.suburbName.value.trim(),
        province: form.province.value.trim(),
        postalCode: form.postalCode.value.trim()
      };

      submitBtn.textContent = 'Checking availability…';
      submitBtn.disabled = true;
      openBtn && (openBtn.disabled = true);

      try {
        const result = await checkCoverage(address);
        showToast('success', 'Coverage information received.');
        // Replace modal contents with the result view (do NOT close modal)
        renderResult(result, address);
      } catch (err) {
        console.error(err);
        showToast('error', 'Unable to complete coverage check. Please try again.');
      } finally {
        openBtn && (openBtn.disabled = false);
        submitBtn.textContent = 'Check availability';
        submitBtn.disabled = false;
      }
    });
  </script>

  <!-- Ionicons (for icons used in header buttons) -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <!-- Your site-wide JS (if any) -->
  <!-- <script src="./assets/js/script.js"></script> -->
</body>

</html>